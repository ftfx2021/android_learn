安卓端下放数据
  ```
typedef enum {
    OFF,
    ON
} Switch;
  ```
  ### 电器控制数据
  ```
  typedef struct {
    int color_r;
    int color_g;
    int color_b;
    Switch state;
} LEDData;
  typedef struct {
  Switch state;
  Switch fan_speed;
  Switch fan-direction;
} FanData;

```
```
typedef struct {
  Switch bedroom_led;
  LEDData livingrom_led;
  Switch tolit_led;
  Switch curtain_switch;
  FanData fan;
  Switch alarm_switch
} ApplicationGroup;

ApplicationGroup applications;
```
  ### 情景模式
  ```
typedef enum {
    EMPTY = 0,
    MOVIE = 1,
    SLEEP = 2,
    AWAY = 3,
    HOME = 4,
    CUSTOM = 5
} SceneMode;
SceneMode current_mode = EMPTY;
  ```
### 自定义模式数据
  ```
typedef struct {
    Switch bedroom_light;
    Switch living_room_light;
    Switch tolit_light;
    Switch curtain;
    Switch fan;
    Switch alarm;
} CustomModeData;

CustomModeData customModeData
  ```
### 自动化模式数据
```
typedef struct {
    AutoController fan_temperature; // 温度高阈值
    AutoController led_light;
    AutoController curtain_light;
    AutoController alarm_ppm;
} AutoModeData;
typedef struct{
  int high;
  int low;
  Switch state_high;
  Switch state_low;
}AutoController
AutoModeData autoModeData;
```

### 自动化控制
```
void auto_mode_check(){
if(autoModeData.fan_temperature.state_high == ON){
  if(temperature > autoModeData.fan_temperature.high){
  applications.fan.state = ON;
}
if(autoModeData.fan_temperature.state_low == ON){
  if(temperature < autoModeData.fan_temperature_.low){
  applications.fan.state = OFF;
}
if(autoModeData.led_light.state_high == ON){
  if(lightLux > autoModeData.led_light.high){
  applications.livingrom_led.state = ON;
}
if(autoModeData.led_light.state_low == ON){
  if(lightLux < autoModeData.led_light.low){
  applications.livingrom_led.state = OFF;
}
if(autoModeData.curtain_light.state_high == ON){
  if(lightLux > autoModeData.curtain_light.high){
  applications.curtain_switch.state = ON;
}
if(autoModeData.curtain_light.state_low == ON){
  if(lightLux < autoModeData.curtain_light.low){
  applications.curtain_switch.state = OFF;
}
if(autoModeData.alarm_ppm.state_high== ON){
  if(ppm > (autoModeData.alarm_ppm.high){
  applications.alarm_switch.state = ON;
  open_beep();
}


}

}
```
### 用户上线\下线
```
  typedef struct{
  char * username;
  char * real_name;
  int  state;
}UserState;
UserState userState
```
### 闹钟
```
  typedef struct{
  char * time;
  Switch state;
  }AlarmClock
  AlarmClock alarmClock
```
### 定时事件
```
  typedef struct{
  char * name;
  char * time;
  Switch state;
}TimingEvent;

typedef struct{
TimingEvent event1;
TimingEvent event2;
TimingEvent event3;

}TimingEventGroup;
TimingEventGroup timingEventGroup;
//处理定时事件
void deal_timing_event(char * eventName);{
  switch(eventName){
    case "BEDROOM_ON":applications.bedroom_led=ON;  sendData() ;break;
    case "BEDROOM_OFF":applications.bedroom_led=OFF; ;break;
    case "LIVINGROOM_ON":applications.livingrom_led.state=ON  ; break;
    case "LIVINGROOM_OFF": applications.livingrom_led.state=OFF ; break;
    case "TOTAIL_ON": applications.tolit_led = ON ; break;
    case "TOTAIL_OFF": applications.tolit_led = OFF ; break;
    case "FAN_ON": application.FanData.switch = ON ;break;
    case "FAN_OFF": application.FanData.switch = OFF ;break;
    case "CURTAIN_ON": applications.curtain_switch = ON ;break;
    case "CURTAIN_OFF":applications.curtain_switch = OFF  ;break;
default:break;
}

}
void timing_event_check(){
  Switch eventState1 = timingEventGroup.event1.state;
   Switch eventState2 = timingEventGroup.event2.state;
 Switch eventState3 = timingEventGroup.event3.state;
char * time1 = timingEventGroup.event1.time;
char * time2 = timingEventGroup.event2.time;
char * time3 = timingEventGroup.event3.time;
  if(currentTime = time1&&eventState1 == ON ){
  char * eventName1 =  timingEventGroup.event1.name;
  deal_timing_event(eventName1);
}
  if(currentTime = time2&&eventState2 == ON){
 char * eventName2 =  timingEventGroup.event2.name;
  deal_timing_event(eventName2);
}
  if(currentTime = time3&&eventState3 == ON){
 char * eventName3 =  timingEventGroup.event3.name;
  deal_timing_event(eventName3);
}
  
}
//闹钟
void alarm_clock_check(){

if(currentTime = AlarmClock.time&&AlarmClock.state==ON){
  open_bean();
 }

}

fun open_beep(){
if()
beep=1;
delay(1000);
beep=0;
}
```
###
### 情景模式
```
  fun scene_mode_control( ){
  switch(current_mode){
  case MOVIE:mode_movie();break;
  case SLEEP:mode_sleep();break;
  case AWAY:mode_away();break;
  case HOME:mode_home();break;
  case CUSTOM:mode_custom();break;
  default:break;
}
}
```
#### 睡眠模式
  - 卧室灯开启，其余灯关闭，窗帘关闭.风扇不动
```
  void mode_sleep(){
applications.bedroom_led=ON;
sendData();
applications.livingrom_led.state = OFF
sendData()
applications.tolit_led = OFF
sendData()
applications.curtain_switch = OFF
sendData()
/*控制电器，发送数据*/
  sendData()
}
  
```
#### 离家模式
  - 所有设备关闭
```
  void mode_away(){
applications.bedroom_led=OFF;
sendData();
applications.livingrom_led.state = OFF
sendData()
applications.tolit_led = OFF
sendData()
applications.curtain_switch = OFF
sendData()
application.FanData.state = OFF
sendData()
  
}
```
#### 观影模式
  - 客厅LED调为暖色
  - 窗帘关闭
  - 其余灯关闭
```
  void mode_movie(){
applications.bedroom_led=OFF;
sendData();
applications.livingrom_led.state = ON;
application.livingroom_led.color_r = 255;
application.livingroom_led.color_g = 220;
application.livingroom_led.color_b = 170;
sendData()
applications.tolit_led = OFF
sendData()
applications.curtain_switch = OFF
sendData()
}
```
#### 回家模式
  - 根据时间/温度决定是否开灯，开风扇
```
void mode_home(){
if(temperature > autoModeData.fan_temperature.high && autoModeData.fan_temperature.state_high = ON){
  applications.FanData.state = ON
  sendData()
}
if(temperature < autoModeData.fan_temperature.low && autoModeData.fan_temperature.state_low = ON){
  applications.FanData.state = OFF
  sendData()
}
if(light > autoModeData.led_light.high && autoModeData.led_light.state_high = ON){
  applications.livingrom_led.state = ON
  sendData()
}
if(light < autoModeData.led_light.low && autoModeData.led_light.state_low = ON){
  applications.livingrom_led.state = OFF
  sendData()
}
if(light > autoModeData.curtain_light.high && autoModeData.curtain_light.state_high = ON){
  applications.curtain_switch = ON
  sendData()
}
if(light < autoModeData.curtain_light.low && autoModeData.curtain_light.state_low = ON){
  applications.curtain_switch = OFF
  sendData()
}

}
```
#### 自定义模式
```
void mode_custom(){
applications.bedroom_led=customModeData.bedroom_light;
sendData();
applications.livingrom_led.state = customModeData.living_room_light;
sendData();
applications.tolit_led = customModeData.tolit_light;
sendData();
applications.curtain_switch = customModeData.curtain;
sendData();
application.FanData.switch = customModeData.fan;
sendData();
application.alarm_switch = customModeData.alarm;
sendData();
  
}
```

### 数据解析
收到含smart_set的数据包->解析->更新数据updateData()->发送ACK:{stm32_set:{recv:ok}}

```
    cJSON* smart_set = cJSON_GetObjectItem(root, "smart_set");
    if (smart_set == NULL) {
        printf("Error: smart_set not found in JSON\n");
        cJSON_Delete(root);
        return NULL;
    }
```
- 用户数据
```
    cJSON* userState = cJSON_GetObjectItem(smart_set, "userState");
    if (userState == NULL) {
        printf("Error: userState not found in JSON\n");
        cJSON_Delete(root);
        return NULL;
    }else{
   userState->username = strdup(cJSON_GetObjectItem(userState, "username")->valuestring);
    userState->real_name = strdup(cJSON_GetObjectItem(userState, "realName")->valuestring);
    userState->state = cJSON_GetObjectItem(userState, "state")->valueint;
}
```
- alarmController
```
   cJSON* alarmController = cJSON_GetObjectItem(smart_set, "alarmController");
    if (alarmClock == NULL) {
        printf("Error: alarmController not found in JSON\n");
        cJSON_Delete(root);
        return NULL;
    }else{
    char *autoModeName = strdup(cJSON_GetObjectItem(alarmController, "name")->valuestring);
    int low = cJSON_GetObjectItem(alarmClock, "low")->valueint;
    int high = cJSON_GetObjectItem(alarmClock, "high")->valueint;
    int stateHigh = cJSON_GetObjectItem(alarmClock, "stateHigh")->valueint;
    int stateLow = cJSON_GetObjectItem(alarmClock, "stateLow")->valueint;
switch (autoModeName){
case "fanTemperature":{
  autoModeData->fan_temperature.high = high;
  autoModeData->fan_temperature.low = low;
  autoModeData->fan_temperature.state_high = stateHigh;
  autoModeData->fan_temperature.state_low = stateLow;
  };break;
case "ledLight":{
  autoModeData->led_light.high = high;
  autoModeData->led_light.low = low;
  autoModeData->led_light.state_high = stateHigh;
  autoModeData->led_light.state_low = stateLow;
  };break;
case "curtainLight":{
  autoModeData->curtain_light.high = high;
  autoModeData->curtain_light.low = low;
  autoModeData->curtain_light.state_high = stateHigh;
  autoModeData->curtain_light.state_low = stateLow;
  };break;
case "alarmPpm":{
  autoModeData->alarm_ppm.high = high;
  autoModeData->alarm_ppm.low = low;
  autoModeData->alarm_ppm.state_high = stateHigh;
  autoModeData->alarm_ppm.state_low = stateLow;
  };break;
  else:break;
  }
}
```
- 闹钟
```
 cJSON* alarmClock = cJSON_GetObjectItem(smart_set, "alarmClock");
    if (alarmClock == NULL) {
        printf("Error: alarmClock not found in JSON\n");
        cJSON_Delete(root);
        return NULL;
    }else{

 alarmClock->time = strdup(cJSON_GetObjectItem(alarmClock, "time")->valuestring);
    alarmClock->enable = cJSON_GetObjectItem(alarmClock, "enable")->valueint;
}
```
- 定时事件
```
TimingEventGroup.event1
  typedef struct{
  char * name;
  char * time;
  Switch state;
}TimingEvent;

  cJSON* timerEvent = cJSON_GetObjectItem(smart_set, "timerEvent");
    if (timerEvent == NULL) {
        printf("Error: timerEvent not found in JSON\n");
        cJSON_Delete(root);
        return NULL;
    }else{

 int id = cJSON_GetObjectItem(timerEvent, "id")->valueint;
    char * time = strdup(cJSON_GetObjectItem(timerEvent, "time")->valuestring);
    char *eventName = strdup(cJSON_GetObjectItem(timerEvent, "eventName")->valuestring);
    int state = cJSON_GetObjectItem(timerEvent, "state")->valueint;
switch(id){
case 1:{
timingEventGroup.event1.name = name;
timingEventGroup.event1.time = time
timingEventGroup.event1.state = state;
};break;
case 2:{
timingEventGroup.event2.name = name;
timingEventGroup.event2.time = time
timingEventGroup.event2.state = state;
};break;
case 3:{
timingEventGroup.event3.name = name;
timingEventGroup.event3.time = time
timingEventGroup.event3.state = state;
};break;
else:break;


}

}
```
### 主函数
  - 10s上报一次环境数据
  - （中断）电器状态变化 ->  结构体更新  发送数据到phone 无需确认
  - 流程
    + 基本初始化
    + WIFI模块初始化 -> 发送初始化结果到Phone
    +  指纹识别，发送识别结果
    +  识别成功，进入主循环
    +  上报给阿里云，设备已经上线
  - 每10秒上传环境数据
  - 不断检测是否有数据发来，有则做处理并发送对应ack
    + 有情景模式数据发来 - 
  - 循环检测情景模式，根据SceneMode来设置情景模式，SceneMode current_mode = EMPTY则不做处理
  - 循环检测自动化模式的数据，满足条件则设置相关设备
  - 循环检测用户在线状态，并显示在OLED上
  - AT指令每5秒更新一次系统时间

```
while(1){

update_environment_data();
timing_event_check();
alarm_clock_check();
auto_mode_check()


}
```
    
    
